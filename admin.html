<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://fonts.googleapis.com/css?family=Khand|Overpass+Mono" rel="stylesheet">
    <title>Roborace Laps Counter</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #root {
            font-family: Khand, sans-serif;
            height: 100vh;
            background: #3c4a61;
            color: white;
        }

        #header {
            flex-grow: 0;
            font-size: 6vh;
            text-align: center;
        }

        #menu {
            flex-grow: 0;
            font-size: 3.5vw;
            display: flex;
            justify-content: space-between;
            padding: 0 15vw;
        }

        #race-state {
            color: #ebd16a;
        }

        #stopwatch {
            margin-left: 20px;
            font-family: 'Overpass Mono', monospace;
        }

        #buttons {
            font-size: 4vh;
            text-align: center;
            padding: 1vw 0;
            position: absolute;
            bottom: 0;
            width: 100vw;
        }

        .block {
            display: inline-block;
            padding: 0 10px
        }

        input {
            font-family: Khand, sans-serif;
            font-size: 4vh;
        }

        #content table {
            border-collapse: collapse;
        }

        #content th, td {
            font-size: 3vw;
            padding: 0.3vh 0.5vw;
            margin: 0;
            border: 1px solid #d5d5d5;
            text-align: center;
        }

        #content input {
            margin: 0 0.5vw;
            padding: 0 1vw;
            font-size: 2vw;
        }

    </style>
</head>
<body>
<div id="root">
    <div id="header">Roborace Laps Counter</div>
    <div id="menu">
        <!--<div>Laps: 25</div>-->
        <div>State: <span id="race-state">NOT CONNECTED</span></div>
        <div>Race Time: <span id="stopwatch">0:00.000</span></div>
    </div>
    <div id="content">

        <table style="margin: auto">
            <thead>
            <tr>
                <th>Start #</th>
                <th>Serial</th>
                <th>Control</th>
                <th>Name</th>
                <th>Place</th>
                <th>Laps</th>
                <th>Time</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

    </div>
    <div id="buttons">
        <div id="config" class="block">
            <input type="text" id="ip" value="ws://192.168.1.200:8888/ws">
            <input type="button" id="btn-connect" value="Connect">
        </div>
        <div id="control" class="block" style="display: none">
            <input type="button" class="btn-command" id="btn-ready" value="READY" data-command="READY">
            <input type="button" class="btn-command" id="btn-steady" value="STEADY" data-command="STEADY">
            <input type="button" class="btn-command" id="btn-go" value="GO" data-command="RUNNING">
            <input type="button" class="btn-command" id="btn-finish" value="FINISH" data-command="FINISH">
        </div>
    </div>
</div>
<script>
    (function () {
        let socket;
        let raceState = 'UNKNOWN';
        let raceTime = 0;
        const robots = {};

        const updateInterval = 9;
        setInterval(function () {
            if (raceState === 'RUNNING') {
                raceTime += updateInterval;
                document.querySelector('#stopwatch').innerHTML = msToTime(raceTime);
            }
        }, updateInterval);

        let wsReconnectTimeoutId = null;

        document.querySelector('#btn-connect').addEventListener('click', function () {
            createConnection();
        });

        const buttons = document.querySelectorAll('.btn-command');
        for (let i = 0; i < buttons.length; i++) {
            buttons[i].addEventListener('click', function (event) {
                const state = event.target.dataset.command;
                const data = {'type': 'COMMAND', 'state': state};
                socket && socket.send(JSON.stringify(data));
            });
        }

        const onClickNum = function (event) {
            const input = event.target;

            let data;
            if (input.dataset.type === 'LAP_MAN') {
                data = {
                    'type': 'LAP_MAN',
                    'serial': parseInt(input.dataset.serial),
                    'laps': parseInt(input.value)
                };
            } else if (input.dataset.type === 'ROBOT_REMOVE') {
                if (confirm("Do you really want to remove robot?")) {
                    data = {
                        'type': 'ROBOT_REMOVE',
                        'serial': parseInt(input.dataset.serial)
                    };
                }
            } else if (input.dataset.type === 'ROBOT_EDIT') {
                data = {
                    'type': 'ROBOT_EDIT',
                    'serial': parseInt(input.dataset.serial),
                    'name': input.previousSibling.value
                };
            }
            if (data !== undefined) {
                socket.send(JSON.stringify(data));
            }
        };

        const types = {
            STATE: function (data) {
                raceState = data.state;
                document.querySelector('#btn-steady').setAttribute('style', 'display: none');
                document.querySelector('#btn-go').setAttribute('style', 'display: none');
                document.querySelector('#btn-finish').setAttribute('style', 'display: none');
                document.querySelector('#btn-ready').setAttribute('style', 'display: none');
                const nextButtonIds = {
                    'READY': '#btn-steady',
                    'STEADY': '#btn-go',
                    'RUNNING': '#btn-finish',
                    'FINISH': '#btn-ready'
                };
                document.querySelector(nextButtonIds[raceState]).setAttribute('style', 'display: visible');
                document.querySelector('#race-state').innerHTML = raceState;
            },
            TIME: function (data) {
                raceTime = data.time;
            },
            LAP: function (data) {
                robots[data.serial] = data;
                let row = document.querySelector('#tbody tr[data-serial="' + data.serial + '"]');
                if (row === null) {
                    const tbody = document.querySelector('#tbody');
                    tbody.innerHTML += '<tr data-serial="' + data.serial + '"></tr>';
                    row = document.querySelector('#tbody tr[data-serial="' + data.serial + '"]');
                }

                let buttons = document.querySelectorAll('#content input');
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].removeEventListener('click', onClickNum);
                }

                row.innerHTML =
                    '<td>' + data.num + '</td>' +
                    '<td>' + data.serial + '</td>' +
                    '<td>' +
                    '<input type="button" value="+1" data-type="LAP_MAN" data-serial="' + data.serial + '">' +
                    '<input type="button" value="-1" data-type="LAP_MAN" data-serial="' + data.serial + '">' +
                    '<input type="button" value="rm" data-type="ROBOT_REMOVE" data-serial="' + data.serial + '">' +
                    '</td>' +
                    '<td><input type="text" value="' + data.name + '"><input type="button" value="ok" data-type="ROBOT_EDIT" data-serial="' + data.serial + '"></td>' +
                    '<td>' + data.place + '</td>' +
                    '<td>' + data.laps + '</td>' +
                    '<td>' + msToTime(data.time) + '</td>'
                ;

                buttons = document.querySelectorAll('#content input[type="button"]');
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].addEventListener('click', onClickNum);
                }

            },
            ROBOT_REMOVE: function (data) {
                robots[data.serial] = null;
                const row = document.querySelector('#tbody tr[data-serial="' + data.serial + '"]');
                row.remove();
            }
        };

        function msToTime(s) {
            let ms = s % 1000;
            s = (s - ms) / 1000;
            if (ms < 10) ms = '00' + ms;
            else if (ms < 100) ms = '0' + ms;

            let secs = s % 60;
            s = (s - secs) / 60;
            if (secs < 10) secs = '0' + secs;

            const mins = s % 60;
            const hrs = (s - mins) / 60;

            let result = mins + ':' + secs + '.' + ms;
            if (hrs > 0) result = hrs + 'h ' + result;
            return result;
        }

        function createConnection() {
            const url = document.querySelector('#ip').value;
            socket = new WebSocket(url);

            function onOpen(event) {
                console.log('connected', event);

                document.querySelector('#control').setAttribute('style', 'display: visible');

                document.querySelector('#config').setAttribute('style', 'display: none');
                const buttons = document.querySelectorAll('#config input');
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].toggleAttribute('disabled');
                }

                socket.send(JSON.stringify({'type': 'LAPS'}));
            }

            function onClose(event) {
                console.log('disconnected', event);

                removeListeners();
                reconnect();
            }

            function onError(event) {
                console.error('error', event);

                removeListeners();
                reconnect();
            }

            function onMessage(event) {
                let data;

                try {
                    data = JSON.parse(event.data);
                    console.log(data);
                } catch (error) {
                    console.error('Message should have JSON format');
                    return;
                }

                types[data.type] && types[data.type](data);
            }

            function removeListeners() {
                socket.removeEventListener('open', onOpen);
                socket.removeEventListener('close', onClose);
                socket.removeEventListener('error', onError);
                socket.removeEventListener('message', onMessage);
            }

            socket.addEventListener('open', onOpen);
            socket.addEventListener('close', onClose);
            socket.addEventListener('error', onError);
            socket.addEventListener('message', onMessage);
        }

        function reconnect() {
            if (wsReconnectTimeoutId) {
                clearTimeout(wsReconnectTimeoutId);
            }

            console.log('attempt to reconnect');

            wsReconnectTimeoutId = setTimeout(createConnection, 1000);
        }
    })();
</script>
</body>
</html>
